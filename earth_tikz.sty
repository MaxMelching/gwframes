% Author: Izaak Neutelings (January 2024)
% Adapted in 2025 by Max Melching from https://tikz.net/astronomy_seasons/


\ProvidesPackage{earth_tikz}

\RequirePackage{tikz}
\RequirePackage{tikz-3dplot}
\RequirePackage{xcolor}

% \usepackage{pgfplots}
% \pgfplotsset{compat=1.11}  % Testing if this makes random steps work again


% -- For reproducible results, we set seeds
\pgfmathsetseed{96}


\usetikzlibrary{
    arrows.meta,bending, % for arrow head size
    calc, % for calculating coordinates
    decorations.pathmorphing, % for random steps
    decorations.pathreplacing, % for braces
    fpu, % for higher precision in "random steps"
    intersections,
}

% FADINGS
\usetikzlibrary{fadings}
\begin{tikzfadingfrompicture}[name=halo]
  \shade[inner color=transparent!0,outer color=transparent!100] (0,0) circle (0.9);
\end{tikzfadingfrompicture}

% COLORS
% \colorlet{water}{blue!70!cyan!80}
\colorlet{water}{blue!80!cyan!90!black}
\colorlet{grass}{green!70!teal!90!black}
\colorlet{sand}{yellow!70!brown!90!black}
\colorlet{shadow}{water!60!black}


% -- Define a variable to track if defaults were applied
\def\cbcframes@earthcalledfrombinary{false}


\pgfkeys{
	/frames/earth/.is family, /frames/earth,
	default/.style = {
        radius = 1,
        tilt = 0,
    },
    radius/.estore in = \earth@RE,
    tilt/.estore in = \earth@angE,
}

\pgfkeys{/frames/earth, default}  % Probably not required, but I want to make absolutely sure everything is defined -> we actually rely on this in cbc_frames_tikz, so definitely needed


\tikzset{
    >={Stealth[inset=0,angle'=27]},
    /pgf/fpu/install only={reciprocal}, % for higher precision in "random steps"
	% wrinkle/.style={rounded corners=0.2pt,decorate,decoration={random steps,segment length=1pt,amplitude=0.2pt}},  % Original, also error now
    % wrinkle/.style={rounded corners=0.6,decorate,decoration={random steps,segment length=0.5,amplitude=0.6}}, % For higher RE, things have to be changed here as well. So increasing scale is better solution -> ah, scale does not really help... So we do manually again
    wrinkle/.style={rounded corners=0.2,decorate,decoration={random steps,segment length=1,amplitude=0.4}}, % New configuration
    land/.style={ultra thin,draw=#1!40!black,rotate=-\earth@angE,postaction={fill=#1},wrinkle},
    mysmallarrow/.style={-{Latex[length=3,width=2,bend]},red,line width=0.4,line cap=round},
}


\newcommand{\drawearth}[1][]{%
    \ifthenelse{\equal{\cbcframes@earthcalledfrombinary}{true}}{
    }{
	   \pgfkeys{/frames/earth, default, #1}
    }


    \begin{scope}
        \fill[water] (0,0) circle(\earth@RE); % Earth fill (even)

        \begin{scope} % clip
            \clip (0,0) circle(\earth@RE);


            \fill[land=grass,rotate=-2] % land mass
            (-30:0.36*\earth@RE) ellipse({0.22*\earth@RE} and {0.50*\earth@RE}) % Africa south
            (45:0.17*\earth@RE) ellipse({0.39*\earth@RE} and {0.21*\earth@RE}) % North Africa
            {[rotate=22] (31:0.83*\earth@RE) ellipse({0.45*\earth@RE} and {0.28*\earth@RE})} % Asia
            {[rotate=38] (54:0.55*\earth@RE) ellipse({0.33*\earth@RE} and {0.09*\earth@RE})} % West Europa
            {[rotate=22] (65:0.79*\earth@RE) ellipse({0.19*\earth@RE} and {0.04*\earth@RE})} % North Europa
            {[rotate=-10] (216:1.10*\earth@RE) ellipse({0.22*\earth@RE} and {0.40*\earth@RE})} % South America
            ;
            \fill[land=sand] % sahara
            (46:0.18*\earth@RE) ellipse({0.35*\earth@RE} and {0.16*\earth@RE});
            \fill[land=sand,rotate=22] % Middle East
            (24:0.69*\earth@RE) ellipse({0.26*\earth@RE} and {0.07*\earth@RE});
            \fill[land=white,rotate=-65] (186:0.95*\earth@RE) ellipse({0.08*\earth@RE} and {0.20*\earth@RE}); % Greenland
            \fill[land=white] (88:\earth@RE) ellipse({0.4*\earth@RE} and {0.13*\earth@RE}); % ice sheet north
            \fill[land=white] (-96:\earth@RE) ellipse({0.4*\earth@RE} and {0.1*\earth@RE}); % ice sheet south


            \fill[path fading=halo,white,opacity=0.42] % create bright spot shifted towards sun
            (-180:{0.7*\earth@RE} and {0.2*\earth@RE}) circle(1.2*\earth@RE);
        \end{scope}
        \draw[black,ultra thin] (0,0) circle(\earth@RE); % Earth outline
    \end{scope}
}
